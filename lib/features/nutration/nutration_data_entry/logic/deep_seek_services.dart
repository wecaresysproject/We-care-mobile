import 'dart:convert';

import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:http/http.dart' as http;
import 'package:we_care/core/global/Helpers/app_logger.dart';
import 'package:we_care/features/nutration/data/models/nutration_facts_data_model.dart';
import 'package:we_care/features/nutration/data/models/single_nutrient_model.dart';

class DeepSeekService {
  static final String deepSeekBaseUrl = dotenv.env['DEEPSEEK_BASE_URL'] ?? "";

  static final String apiKey = dotenv.env['DEEPSEEK_API_KEY'] ?? "";
  static Future<NutrationFactsModel?> analyzeDietPlan(String dietInput) async {
    try {
      AppLogger.debug(' deepSeekBaseUrl: $apiKey $deepSeekBaseUrl');
      final prompt = buildNutritionPrompt(dietInput);
      AppLogger.debug('Prompt: $prompt');

      final response = await http.post(
        Uri.parse(deepSeekBaseUrl),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $apiKey',
        },
        body: jsonEncode({
          'model': "deepseek/deepseek-chat",
          'messages': [
            {
              'role': 'user',
              'content': prompt,
            }
          ],
          'max_tokens': 4000,
          'temperature': 0.3,
        }),
      );

      if (response.statusCode == 200) {
        /// ๐ฅ ููุง ุงูุฅุตูุงุญ ุงูุฃุณุงุณู โ UTF8 correct decoding
        final decoded = jsonDecode(utf8.decode(response.bodyBytes));

        final content = decoded['choices'][0]['message']['content'];
        AppLogger.debug('deepseek Response (decoded): $content');

        /// ุงุณุชุฎุฑุงุฌ JSON ูู ุงููุต
        final jsonMatch = RegExp(r'\{.*\}', dotAll: true).firstMatch(content);

        if (jsonMatch != null) {
          final jsonString = jsonMatch.group(0)!;

          /// parse JSON
          final nutritionJson = jsonDecode(jsonString);

          return NutrationFactsModel.fromJson(nutritionJson);
        }

        AppLogger.error("โ JSON not found inside LLM response");
      } else {
        AppLogger.error(
            'deepseek API Error: ${response.statusCode} - ${response.body}');
      }
    } catch (e) {
      AppLogger.error('Error analyzing diet plan: $e');
    }

    return null;
  }

  static String buildNutritionPrompt(String dietInput) {
    return '''
ุฃูุช ูุญูู ุบุฐุงุฆู ุชูููุฐู ูุชุฎุตุต ูู ุชุญููู ุงูุฃุตูุงู ุงูุบุฐุงุฆูุฉ ุงุนุชูุงุฏูุง ุนูู ุฎูุงุฑุฒููุฉ ุชูุตูููุฉ ูุนูุฏุฉ.

ูููุชู ูู ูุฐู ุงูุฌูุณุฉ ูู:

1) ูุฑุงุกุฉ "ุงูุฎูุงุฑุฒููุฉ ุงูุดุงููุฉ ููุธุงู ุชุญููู ุงูุชุบุฐูุฉ" ุงูููุฌูุฏุฉ ูุงุญููุง ูู ูุฐุง ุงูุจุฑููุจุช (ุงููุต ุงููุงูู ููุง ูู ุจุฏูู ุฃู ุชุนุฏูู).
2) ุชุทุจูู ูู ุงููุฑุงุญู ูุงูุฎุทูุงุช ุงููุฐููุฑุฉ ูู ุงูุฎูุงุฑุฒููุฉ **ุจุงูุชุฑุชูุจ ูุจุฏูู ุงุฎุชุตุงุฑ ุฃู ุญุฐู ูุฃู ูุงุนุฏุฉ**:
   - ุงููุฑุญูุฉ 0: ุงูุชุนุฑููุงุช ุงูุซุงุจุชุฉ
   - ุงููุฑุญูุฉ 1: ูุนุงูุฌุฉ ูู ุตูู ูู ูุงุฆูุฉ ุงูุทุนุงู
   - ุงููุฑุญูุฉ 2: ุชุนููู ูุฑุงุฌุน USDA ููููููุงุช
   - ุงููุฑุญูุฉ 3: ุงูุญุณุงุจ ุงูุบุฐุงุฆู
   - ุงููุฑุญูุฉ 4: ุงูุชุฌููุน ูุงูุชุญูู
   - ุงููุฑุญูุฉ 5: ุงูุฅุฎุฑุงุฌ ุงูููุงุฆู
3) ุงุณุชุฎุฏุงู ููุณ ุงูููุทู ูุงูุฌุฏุงูู ูุงูููุงุนุฏ ุงููุฐููุฑุฉ ุจุงูุถุจุท (ูุถุงุนูุงุช ุงูุญุตุตุ ูุณุจ ุงููุญู ุฅูู ุงูุนุธูุ ููุงุนุฏ ุงุณุชุจุนุงุฏ ุงูููููุงุชุ ุชุญููู ุงููุญุฏุงุชุ ุนุฏุฏ ุงูุฃุนูุฏุฉุ ุฅูุฎ).
4) ุจุนุฏ ุชูููุฐ ุงูุฎูุงุฑุฒููุฉ ุจุงููุงูู ุนูู "ุงูุทุนุงู ุงููุฏุฎู ุงููุนูู" ุงูุฐู ุณูุชู ุชุฒููุฏู ุจู ูู ูุฐุง ุงูุจุฑููุจุชุ ูุฌุจ ุฃู ุชูุฑุฌูุน **JSON ููุท** ุจุงููููู ุงููุญุฏุฏ ุฃุฏูุงู **ุจุฏูู ุฃู ูุต ุฅุถุงูู ูุจูู ุฃู ุจุนุฏู**.

โ๏ธ ุชูุจูู ุจุงูุบ ุงูุฃูููุฉ:
- ูุต ุงูุฎูุงุฑุฒููุฉ ุงููุงูู ุงููุฑูู ุฃุฏูุงู ูุญุชูู ูู ุขุฎุฑู ุนูู ุณุทุฑ ูุจุฏุฃ ุจู: "ุงูุทุนุงู ุงููุฏุฎู:" ูุชุจูุนูุง ุจูุงุฆูุฉ ุฃุทุนูุฉ ูุซู "ุฏููุฉ ุจุงููุฉุ ูุณูุนุฉ ุจุงููุญู ุงูููุฑููุ ...".
- ูุฐู ุงููุงุฆูุฉ ูู **ูุซุงู ุชูุถูุญู ููุท** ุถูู ูุตู ุงูุฎูุงุฑุฒููุฉุ ูููุณุช ุงูุทุนุงู ุงูุญูููู ุงููุทููุจ ุชุญูููู ูู ูุฐู ุงูุฌูุณุฉ.
- **ูุฌุจ ุชุฌุงููู ูุฐุง ุงููุซุงู ุชูุงููุง** ูุนุฏู ุงุณุชุฎุฏุงูู ูู ุงูุชุญููู ูู ูุฐู ุงูุฌูุณุฉ.
- ุงูุทุนุงู ุงูุญูููู ุงููุทููุจ ุชุญูููู ูู ุงููุต ุงูููุฌูุฏ ูู ุงููุชุบูุฑ ุงูุชุงูู ุฏุงุฎู ูุฐุง ุงูุจุฑููุจุช:

=====================================================================
๐ ุงูุทุนุงู ุงููุฏุฎู ุงููุนูู ููุชุญููู (Actual User Diet Input)
=====================================================================

"$dietInput"

=====================================================================
๐ ูููู JSON ุงูุฅูุฒุงูู ุงูููุงุฆู (Required JSON Output Structure)
=====================================================================

ูุฌุจ ุฃู ูููู ุงูุฅุฎุฑุงุฌ ุงูููุงุฆู ูุงุฆู JSON ูุงุญุฏ ููุท ุจุงูุดูู ุงูุชุงูู (ุจููุณ ุฃุณูุงุก ุงูุญููู):

{
  "userDietplan": "UserDietPlan",
  "foodItems": [
    {
      "foodName": "ุงุณู ุงูุตูู ุงูุบุฐุงุฆู ุจุนุฏ ุงูุชูุณูุฑ",
      "servingSize": "ูุซุงู: 1 cup, ุทุจู ูุชูุณุท, 3/4 ููุจ ...",
      "mainIngredient": "ุงููููู ุงูุฃุณุงุณู ุฃู ุงูุงุณู ุงูููุญุฏ ููุตูู",
      "amount": 0,
      "unit": "g",
      "analysisMethod": "USDA_DIRECT_MATCH ุฃู RECIPE_DECOMPOSITION",
      "recipeSource": "ุงุณู ูุตุฏุฑ ุงููุตูุฉ ุฃู '-' ุฅุฐุง ูุง ููุฌุฏ",
      "usdaFdcId": "ุฑูู FDC ID ููุตุ ุฃุฑูุงู ููุท",
      "usdaDescription": "ุงููุตู ุงููุงูู ููุตูู ููุง ูู USDA",

      "calories": 0,
      "protein": 0,
      "totalFat": 0,
      "saturatedFats": 0,
      "monounsaturatedFats": 0,
      "polyunsaturatedFats": 0,
      "cholesterol": 0,
      "carbohydrates": 0,
      "fiber": 0,
      "sugars": 0,
      "sodium": 0,
      "potassium": 0,
      "calcium": 0,
      "iron": 0,
      "magnesium": 0,
      "zinc": 0,
      "copper": 0,
      "phosphorus": 0,
      "manganese": 0,
      "seleniumMcg": 0,
      "iodineMcg": 0,
      "vitaminAMcg": 0,
      "vitaminDMcg": 0,
      "vitaminEMg": 0,
      "vitaminKMcg": 0,
      "vitaminCMg": 0,
      "vitaminB1Mg": 0,
      "vitaminB2Mg": 0,
      "vitaminB3Mg": 0,
      "vitaminB6Mg": 0,
      "folateMcg": 0,
      "vitaminB12Mcg": 0,
      "cholineMg": 0,
      "waterL": 0
    }
  ]
}

ุงูููุงุนุฏ ุงูุฅูุฒุงููุฉ ููุฅุฎุฑุงุฌ:
- ุฃุฑุฌูุน JSON ูุงุญุฏ ููุท ุจุฏูู ุฃู ุดุฑุญ ุฃู ูุต ุฎุงุฑุฌู.
- ูู ุนูุตุฑ ุฏุงุฎู ุงููุตูููุฉ "foodItems" ูุฌุจ ุฃู ูุญุชูู **ุฌููุน ุงูุญููู ุงููุฐููุฑุฉ** ุฃุนูุงูุ ุจูุง ูู ุฐูู ุงูุนูุงุตุฑ ุงูุบุฐุงุฆูุฉ ุงูู 34 ูุงููุฉ ุญุชู ูู ูููุชูุง 0.
- ุงูุญูู "userDietplan" ุงุฌุนูู ุฏุงุฆููุง ุงููููุฉ ุงููุตูุฉ ุงูุซุงุจุชุฉ: "UserDietPlan" ูู ูุฐุง ุงูุณูุงูุ ุฅูุง ุฅุฐุง ุทูููุจ ุบูุฑ ุฐูู ุตุฑุงุญุฉู.
- ุงูุญููู ุงูุฑูููุฉ ูุฌุจ ุฃู ุชููู ุฃุฑูุงููุง (integer ุฃู float) ูุงุจูุฉ ููู JSON.
- ูุง ุชุณุชุฎุฏู Markdownุ ูุง ุชุณุชุฎุฏู ```ุ ูุง ุชุถู ุฃู ุฌููุฉ ุชูุณูุฑูุฉ.

ุจุนุฏ ูุฑุงุกุฉ ุงูุฎูุงุฑุฒููุฉ ุงูุชุงููุฉ ูุชูููุฐูุง ุนูู "$dietInput"ุ ูุฌุจ ุฃู ุชูุชุฌ ูุจุงุดุฑุฉ ุงููุงุฆู JSON ุงูููุงุฆู ููุท.

=====================================================================
๐ ุงูุฎูุงุฑุฒููุฉ ุงูุดุงููุฉ ููุธุงู ุชุญููู ุงูุชุบุฐูุฉ (ูุฌุจ ุชุทุจูููุง ููุง ูู)
=====================================================================

๐ ุงูุฎูุงุฑุฒููุฉ ุงูุดุงููุฉ ููุธุงู ุชุญููู ุงูุชุบุฐูุฉ
ุงููุฑุญูุฉ 0: ุงูุชุนุฑููุงุช ุงูุซุงุจุชุฉ (ูุชู ุชุญุฏูุฏูุง ูุฑุฉ ูุงุญุฏุฉ)
text
ูุงุฆูุฉ ุงูุนูุงุตุฑ ุงูุบุฐุงุฆูุฉ: ุงูู 34 ุนูุตุฑุงู ุงููุญุฏุฏุฉ:

ุชุณูุณู ุงููุตุงุฏุฑ ุงููุญููุฉ: 
ููุงู ุงูุนุงูู
ูุชุงููุช
ูุทุจุฎ ุณูุฏุชู
BBC Good Food
AllRecipes
Serious Eats
Food Network
Taste of Home
Epicurious
Kitchn
Bon Appรฉtit
JustFood
3. ูุถุงุนูุงุช ุงูุญุตุต:
   - "ุทุจู ูุจูุฑ" = 1.5
   - "ุทุจู ูุชูุณุท" = 1.0
   - "ูุทุนุฉ ูุชูุณุทุฉ" = 0.75  
   - "ููุจ" ุฃู "ุณุงูุฏูุชุด" = 0.5
๐ ููุงุนุฏ ุงูุชูุงุก ุงูููููุงุช ุงูููุนุฏูุฉ (ุดุงููุฉ)
ุงููุงุนุฏุฉ ุงูุฃุณุงุณูุฉ:
ุงุณุชุฎุฑุฌ ุฌููุน ุงูููููุงุช ุงููุฐููุฑุฉ ุตุฑุงุญุฉู ูู ูุณู "ุงูููุงุฏูุฑ" ูู ุงููุตูุฉุ ุซู ุทุจู ุงูููุงุนุฏ ุงูุชุงููุฉ:
1. ุงูููููุงุช ุงููุทููุจ ุฅุฏุฑุงุฌูุง (ุฏุงุฆูุงู)
ุฌููุน ุงูููููุงุช ุงูุชู ููุง ูููุฉ ูุญุฏุฏุฉ ูู ุงููุตูุฉ (ูุซุงู: "2 ููุจ ุฃุฑุฒ"ุ "ููุนูุฉ ุฒูุช ุฒูุชูู").
ุงุณุชุซูุงุก: ุงูููููุงุช ุงูุชู ุชุฎุถุน ูููุงุนุฏุฉ 2 (ุงููุณุชุจุนุฏุฉ).
2. ุงูููููุงุช ุงููุทููุจ ุงุณุชุจุนุงุฏูุง (ุฏุงุฆูุงู)
ุงูููุญ (ุจุฌููุน ุฃุดูุงูู: ููุญ ุทุนุงูุ ููุญ ุจุญุฑุ ุฅูุฎ).
ุงููุงุก ุงููุณุชุฎุฏู ููุณูู/ุงูุทุจุฎ/ุงูููุน (ูุง ูู ููู ูุฑูุงู).
ุงูุฃููุงุณ/ุงูุฃูุฑุงู ุงูุชู ุชูุฒุงู ุจุนุฏ ุงูุชุญุถูุฑ (ุฃููุงุณ ุดุงูุ ูุฑู ุบุงุฑุ ุฅูุฎ).
3. ุงูููููุงุช ุงููุทููุจ ุงุณุชุจุนุงุฏูุง (ุฅุฐุง ูุงูุช ุงููููุฉ ุตุบูุฑุฉ)
ุงูุชูุงุจู ุงููุฌููุฉ: ุฅุฐุง ูุงูุช ูููุชูุง ูู ุงูุญุตุฉ ุงูููุงุฆูุฉ < 1 ุฌุฑุงู (ูุซุงู: ูููู ุฃุณูุฏุ ููููุ ูุฑูู).
ุงูุฃุนุดุงุจ ุงูุทุงุฒุฌุฉ ููุฒููุฉ: ุฅุฐุง ูุงูุช ูููุชูุง ูู ุงูุญุตุฉ ุงูููุงุฆูุฉ < 5 ุฌุฑุงู (ูุซุงู: ุจูุฏููุณ ููุฒููุฉุ ูุนูุงุน ุทุงุฒุฌ ููุฒููุฉ).
ุงูุจูุงุฑุงุช ุงููุทุญููุฉ: ุฅุฐุง ูุงูุช ูููุชูุง ูู ุงูุญุตุฉ ุงูููุงุฆูุฉ < 0.5 ุฌุฑุงู.
4. ูุนุงูุฌุฉ ุฎุงุตุฉ ูููุฌููุนุงุช ุงูุบุฐุงุฆูุฉ

5. ูุงุนุฏุฉ "ุงููููุฉ ุงููุฐููุฑุฉ ุตุฑุงุญุฉู" (ุงูุฃูู)
ุฅุฐุง ูุงูุช ุงููุตูุฉ ุชููู: "ููุญ ููููู ุญุณุจ ุงูุฑุบุจุฉ" โ ุงุณุชุจุนุฏู.
ุฅุฐุง ูุงูุช ุงููุตูุฉ ุชููู: "ููุนูุฉ ุตุบูุฑุฉ ููุญ" โ ุงุณุชุจุนุฏู ุฃูุถุงู (ุจููุฌุจ ุงููุงุนุฏุฉ 2).
ุฎูุงุฑุฒููุฉ ุงูุชุทุจูู ุงูุนููู:
ููุชุญููู_ูู_ูููู(ูููู, ูููุฉ):
  ุฅุฐุง ูุงู ูููู ูู ูุงุฆูุฉ_ุงููุณุชุจุนุฏุฉ_ุฏุงุฆูุงู:
    ุงุณุชุจุนุฏู
    ูุฅูุง ุฅุฐุง ูุงู ูููู ูู ููุน "ุชูุงุจู/ุฃุนุดุงุจ":
    ุฅุฐุง ูุงูุช ูููุฉ_ุงูุญุตุฉ_ุงูููุงุฆูุฉ < ุญุฏ_ุงูุงุณุชุจุนุงุฏ:
      ุงุณุชุจุนุฏู
    ูุฅูุง:
      ุฃุฏุฑุฌู
    ูุฅูุง: # ุฃู ูููู ุขุฎุฑ
    ุฃุฏุฑุฌู
"ูุณุจ ุงููุญู ุฅูู ุงูุนุธู":
ูุณุจ ุงููุญู ุฅูู ุงูุนุธู (Edible Yield Percentage):
1. ุตุฏุฑ ุฏุฌุงุฌ/ุทููุฑ: 70% ูุญู - 30% ุนุธู
2. ุฃูุฎุงุฐ ุฏุฌุงุฌ/ุทููุฑ: 65% ูุญู - 35% ุนุธู
3. ุฃุฌูุญุฉ ุฏุฌุงุฌ/ุทููุฑ: 45% ูุญู - 55% ุนุธู
4. ุฏุฌุงุฌ ูุงูู (ูุทุจูุฎ): 60% ูุญู - 40% ุนุธู
5. ุฃุณูุงู ูุงููุฉ (ูุน ุฑุฃุณ): 40% ูุญู - 60% ุนุธู ููููู
6. ุฃุณูุงู ููููู: 100% ูุญู - 0% ุนุธู
7. ูุทุน ูุญู ูุน ุนุธู (ุถููุน): 75% ูุญู - 25% ุนุธู
8. ูุทุน ูุญู ุจุฏูู ุนุธู: 100% ูุญู - 0% ุนุธู
ุงููุฑุญูุฉ 1: ูุนุงูุฌุฉ ูู ุตูู ูู ูุงุฆูุฉ ุงูุทุนุงู
ุงููุฏุฎู: food_item (ูุซุงู: "ุทุจู ูุชูุณุท ูููุฎูุฉ")
text
ุงูุฎุทูุฉ 1.1: ุชุญุฏูุฏ ุญุฌู ุงูุญุตุฉ (Portion Size Detection)
- ุงุณุชุฎุฑุงุฌ ุงููุงุตู ูู ุงูุงุณู:
  * ุฅุฐุง ุงุญุชูู ุนูู "ุทุจู ูุจูุฑ" โ portion_multiplier = 1.5
  * ุฅุฐุง ุงุญุชูู ุนูู "ุทุจู ูุชูุณุท" โ portion_multiplier = 1.0
  * ุฅุฐุง ุงุญุชูู ุนูู "ูุทุนุฉ ูุชูุณุทุฉ" โ portion_multiplier = 0.75
  * ุฅุฐุง ุงุญุชูู ุนูู "ููุจ" ุฃู "ุณุงูุฏูุชุด" โ portion_multiplier = 0.5
- ุฅุฐุง ูู ูุฐูุฑ: portion_multiplier = 1.0 (ุงูุงูุชุฑุงุถู)
ุงูุชุดุงู ููุน ุงููุทุนุฉ:
ุงููููุงุช ุงูุฏุงูุฉ:
- "ุตุฏุฑ ุฏุฌุงุฌ" โ ููุน = "ุตุฏุฑ_ุทูุฑ" ุ ูุณุจุฉ_ุงููุญู = 0.70
- "ูุฎุฐ ุฏุฌุงุฌ" โ ููุน = "ูุฎุฐ_ุทูุฑ" ุ ูุณุจุฉ_ุงููุญู = 0.65
- "ุณูู ูุงูู" โ ููุน = "ุณูู_ูุงูู" ุ ูุณุจุฉ_ุงููุญู = 0.40
- "ุถููุน ูุญู" โ ููุน = "ูุญู_ูุน_ุนุธู" ุ ูุณุจุฉ_ุงููุญู = 0.75
- "ููููุฉ ุณูู" โ ููุน = "ุณูู_ููููุฉ" ุ ูุณุจุฉ_ุงููุญู = 1.00
ุงูุฎุทูุฉ 1.2: ุงูุจุญุซ ุงููุจุงุดุฑ ูู USDA (USDA Direct Match)
- ุงูุจุญุซ ุจุงุณุชุฎุฏุงู ุงูุงุณู ุงูุฅูุฌููุฒู ุงูููุงุจู + ูุตุทูุญุงุช "cooked", "ready-to-eat"
- ูุนูุงุฑ ุงููุฌุงุญ: ูุฌูุฏ ูุชูุฌุฉ ูุงุญุฏุฉ ูุงุถุญุฉ ุชุทุงุจู ุงุณู ููุตู ุงูุตูู
- ุฅุฐุง ูุฌุญ:
  * analysis_method = "USDA_DIRECT_MATCH"
  * source = "-"
  * ุงุณุชุฎุฏู FDC ID ุงูุฎุงุต ุจุงูุตูู ุงูุฌุงูุฒ
  * ุงูุชูู ุฅูู ุงููุฑุญูุฉ 3 (ุงูุญุณุงุจ)
- ุฅุฐุง ูุดู: ุงูุชูู ุฅูู ุงูุฎุทูุฉ 1.3
ุงูุฎุทูุฉ 1.3: ุงูุจุญุซ ุนู ูุตูุฉ ูู ุงููุตุงุฏุฑ ุงููุญููุฉ (Recipe Decomposition)
For each source in ูุตุงุฏุฑ_ูุญููุฉ (ุจุงูุชุฑุชูุจ):
  - ุงุจุญุซ ุนู "ูุตูุฉ [ุงุณู_ุงูุตูู]" ูู ุงููุตุฏุฑ ุงูุญุงูู
  - ุฅุฐุง ูุฌุฏุช ูุตูุฉ ุชุญุชูู ุนูู ูุณู "ุงูููุงุฏูุฑ" ุฃู "ุงูููููุงุช":
    * analysis_method = "RECIPE_DECOMPOSITION"
    * source = ุงุณู_ุงููุตุฏุฑ
    * ุชููู ุนู ุงูุจุญุซ ูู ุงููุตุงุฏุฑ ุงูุฃุฎุฑู
    * ุงูุชูู ุฅูู ุงูุฎุทูุฉ 1.4
- ุฅุฐุง ุชู ุชุฌุงูุฒ ุฌููุน ุงููุตุงุฏุฑ ุฏูู ูุฌุงุญ:
  * analysis_method = "RECIPE_DECOMPOSITION"
  * source = "JustFood" (ุขุฎุฑ ูุตุฏุฑ)
  * ุงุณุชุฎุฏุงู "ุงูุชุฑุงุถ ููุงุณู" ููุท ูุญู ุฃุฎูุฑ
ุงูุฎุทูุฉ 1.4: ุงุณุชุฎุฑุงุฌ ุงูููููุงุช ูุชูุธูููุง
- ูู ุงููุตูุฉุ ุงุณุชุฎุฑุฌ ุฌููุน ุงูููููุงุช ุงููุฐููุฑุฉ ูู ูุณู "ุงูููุงุฏูุฑ"
- ุชุทุจูู ููุงุนุฏ ุงูุชูุงุก ุงูููููุงุช:
  * ุงุญุชูุธ ุจุงูููููุงุช ูู ูุงุฆูุฉ "ุงููุทููุจ ุฅุฏุฑุงุฌูุง"
  * ุชุฎูุต ูู ุงูููููุงุช ูู ูุงุฆูุฉ "ุงููุทููุจ ุงุณุชุจุนุงุฏูุง"
- ุชูุญูุฏ ุฃุณูุงุก ุงูููููุงุช:
  * ุฅุฒุงูุฉ ูููุงุช ูุซู "ููุทุน"ุ "ููุฑูู"ุ "ููุฒููุฉ"
  * ูุซุงู: "ุจุตู ููุทุน" โ "ุจุตู"
ุงูุฎุทูุฉ 5.1: ุชุญููู ุงููููุงุช ููุญุตุฉ ุงููุงุญุฏุฉ: ุทุจู ูุงุนุฏุฉ ุงูุชุญููู ุงูุซุงุจุชุฉ ุงูุชุงููุฉ ุนูู ุงููููุงุช ุงููุณุชุฎุฑุฌุฉุ ุจูุงุกู ุนูู ูุตู ุงูุญุตุฉ ูู ูุงุฆูุฉ ุงูุทุนุงู ุงููุฏุฎูุฉ:
"ุทุจู ูุจูุฑ" = 1.5 ุญุตุฉ (ุงุถุฑุจ ูููุงุช ูุตูุฉ 4 ุฃุดุฎุงุต ูู 1.5/4)
"ุทุจู ูุชูุณุท" = 1.0 ุญุตุฉ (ุงุถุฑุจ ูููุงุช ูุตูุฉ 4 ุฃุดุฎุงุต ูู 1.0/4)
"ูุทุนุฉ ูุชูุณุทุฉ" = 0.75 ุญุตุฉ (ุงุถุฑุจ ูููุงุช ูุตูุฉ 4 ุฃุดุฎุงุต ูู 0.75/4)
"ููุจ" ุฃู "ุณุงูุฏูุชุด" = 0.5 ุญุตุฉ (ุงุถุฑุจ ูููุงุช ูุตูุฉ 4 ุฃุดุฎุงุต ูู 0.5/4)
ุงูุฎุทูุฉ 1.6: ุงุณุชุฎุฑุงุฌ ูุชุญููู ุงููููุงุช
- ููู ูููู ูุณููุญุ ุงุณุชุฎุฑุฌ ุงููููุฉ ูุงููุญุฏุฉ ูู ุงููุตูุฉ
- ุชุญููู ุฌููุน ุงููุญุฏุงุช ุฅูู ุฌุฑุงู/ูู (ุจุงุณุชุฎุฏุงู ุฌุฏูู ุชุญููู ุซุงุจุช):
- **ุจุงูููุจ**:
  - "1 ููุจ" โ 240 ุฌู
  - "3/4 ููุจ" โ 180 ุฌู
  - "1/2 ููุจ" โ 120 ุฌู
  - "1/4 ููุจ" โ 60 ุฌู
- **ุจุงูููุนูุฉ**:
  - "ููุนูุฉ ูุจูุฑุฉ" โ 15 ุฌู
  - "ููุนูุฉ ุตุบูุฑุฉ" โ 5 ุฌู
  - "ููุนูุฉ ุดุงู" โ 5 ุฌู
- **ุจุงูุทุจู**:
  - "ุทุจู ูุจูุฑ" โ 300 ุฌู
  - "ุทุจู ูุชูุณุท" โ 250 ุฌู
  - "ุทุจู ุตุบูุฑ" โ 180 ุฌู
  - "ุตุญู" โ 150 ุฌู
  * ... ุงูุฎ
ุฅุฐุง ูุงู ุงูุตูู ูุญุชูู ุนูู ุนุธู:
  1. ุงุณุชุฎุฑุฌ ุงููุฒู ุงูููู (ูุจู ุงูุทูู)
  2. ุงุณุชุฎุฑุฌ ููุน ุงููุทุนุฉ ูู ุงููููุงุช ุงูุฏุงูุฉ
  3. ุทุจูู ูุณุจุฉ ุงููุญู ุงูููุงุณุจุฉ
  4. ุงุญุณุจ ุงููุฒู ุงูุตุงูู ููุญู = ุงููุฒู_ุงูููู ร ูุณุจุฉ_ุงููุญู
  5. ุงุญุณุจ ุงููุฒู ุจุนุฏ ุงูุทูู = ุงููุฒู_ุงูุตุงูู ร 0.80 (ููุชุณููุฉ/ุงูุชุญููุฑ)
- ุญุณุงุจ ุงููููุฉ ุงูููุงุฆูุฉ ููุญุตุฉ:
  final_qty = (recipe_qty / base_servings) ร portion_multiplier
  ุญูุซ base_servings = ุนุฏุฏ ุงูุญุตุต ูู ุงููุตูุฉ (ุงูุงูุชุฑุงุถู 4)
ุงูุฎุทูุฉ 1.7: ุงูุชุญูู ูู ุชูููู ุงูููููุงุช (ุฅูุฒุงูู)
ูุจู ุงูุงูุชูุงู ุฅูู ุงููุฑุญูุฉ 2ุ ุชุฃูุฏ ูู:
1. ูู ูููู ูุฑูุจ ุชู ุชููููู ุฅูู ููููุงุช ุฃุณุงุณูุฉ
2. ูุง ููุฌุฏ ูููู ูุญูู ูุตู "ูุฑูุจ" ุฃู "ูุฎููุท"
3. ูู ูููู ุฃุณุงุณู ูููู ุงูุจุญุซ ุนูู ุจุดูู ูููุตู ูู USDA
ูุงุนุฏุฉ ุงูุชุญูู:
- ุฅุฐุง ูุงู analysis_method = "RECIPE_DECOMPOSITION":
  - ูุฌุจ ุฃู ุชุญุชูู ูุงุฆูุฉ ุงูููููุงุช ุนูู 2 ูููู ุนูู ุงูุฃูู
  - ูู ูููู ูุฌุจ ุฃู ูููู ูุงุฏุฉ ุบุฐุงุฆูุฉ ุฃูููุฉ (ููุณ ุทุจูุงู ูุฑูุจุงู)
  - ูุซุงู: "ูุดู ุจุงูุจุตู" โ ["ูุดู ุฌุงู", "ุจุตู", "ุฒูุช ุฒูุชูู"]
  - ุฅุฐุง ูุดู ุงูุชุญูู: ุฃุนุฏ ุงูุฎุทูุฉ 1.4 ุญุชู ูุชู ุงูุชูููู ุงูุตุญูุญ
ุงูุฎุทูุฉ 1.8: ุฅูุดุงุก ูุงุฆูุฉ ุงูููููุงุช ุงูููุงุฆูุฉ (ูููู ุฅูุฒุงูู)
text
ุฃูุดุฆ ุจููุฉ ุจูุงูุงุช ุชุญุชูู ุนูู:
[
  {
    "id": 1,
    "name_ar": "ุงุณู ุงููููู ุจุงูุนุฑุจูุฉ",
    "name_en": "ุงุณู ุงููููู ุจุงูุฅูุฌููุฒูุฉ",
    "qty_grams": ุงููููุฉ ุจุงูุฌุฑุงู,
    "is_from_recipe": true/false,
    "recipe_source": "ุงุณู ุงููุตุฏุฑ" (ุฅุฐุง ูู ูุตูุฉ)
  },
  ... # ููู ูููู
]
ููุงุญุธุฉ: ูุฐู ุงููุงุฆูุฉ ูู ุงููุฏุฎู ุงูุฅูุฒุงูู ูููุฑุญูุฉ 2
ุงููุฑุญูุฉ 2: ุชุนููู ูุฑุงุฌุน USDA ููููููุงุช
## ุงููุฑุญูุฉ 2: ุชุนููู ูุฑุงุฌุน USDA ููููููุงุช
### ูุงุนุฏุฉ ุงูุฑูุถ ุงูุฅูุฒุงููุฉ (ุฌุฏูุฏุฉ)
ูุจู ุจุฏุก ุงููุนุงูุฌุฉุ ุชุญูู ูู ูู ูููู:
- ุฅุฐุง ูุงู ุงุณู ุงููููู ูุญุชูู ุนูู "ูุน" ุฃู "ุจู" ุฃู "ู" ุชุฑุจุท ุจูู ูููููู
- ุฅุฐุง ูุงู ุงูุงุณู ูุดูุฑ ุฅูู ุทุจู ูุฑูุจ ูููุณ ููููุงู ูุฑุฏูุงู
ุงูุฅุฌุฑุงุก: ุนุฏ ููุฑุงู ุฅูู ุงูุฎุทูุฉ 1.7 ูุฅุนุงุฏุฉ ุงูุชูููู.
### ุงูุชูุฑุงุฑ ุงูุฃุณุงุณู
ููู ูููู ูู ูุงุฆูุฉ ุงูููููุงุช ุงูููุงุฆูุฉ (ูู ุงูุฎุทูุฉ 1.8):
  ุงูุฎุทูุฉ 2.1: ุงูุจุญุซ ูู USDA
    - ุงุจุญุซ ุนู ุงูุงุณู ุงูููุญุฏ ูููููู (ุจุงูุฅูุฌููุฒูุฉ)
  ุงูุฎุทูุฉ 2.2: ูุงุนุฏุฉ ุงูุงุฎุชูุงุฑ ุงูุญุชููุฉ (ุงูุฃูู)
    - ุงูุฎูุงุฑ 1: ุฅุฐุง ูุงูุช ููุงู ูุชูุฌุฉ ูุงุญุฏุฉ ููุท ุชุทุงุจู ุงูุงุณู ุจุงูุถุจุท โ ุงุณุชุฎุฏููุง
    - ุงูุฎูุงุฑ 2: ุฅุฐุง ูุงูุช ููุงู ุนุฏุฉ ูุชุงุฆุฌ โ ุงุฎุชุฑ ุฃูู ูุชูุฌุฉ ุชุญุชูู ุนูู ุงููููุฉ ุงูุฃุณุงุณูุฉ ูู ุนููุงููุง
    - ุงูุฎูุงุฑ 3: ุฅุฐุง ูู ุชูุฌุฏ โ ุงุฎุชุฑ ุฃูู ูุชูุฌุฉ ูู ุงููุงุฆูุฉ
  
  ุงูุฎุทูุฉ 2.3: ุงูุชุณุฌูู
    - ุณุฌู: FDC ID (ุฑูู ููุท)
    - ุณุฌู: USDA Description (ุงููุตู ุงููุงูู ููุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช)
  ุงูุฎุทูุฉ 2.4: ุงูุชุญูู ูู ุชุนููู FDC ID (ุฌุฏูุฏุฉ)
    - ุชุญูู 1: ูู FDC ID ุนุจุงุฑุฉ ุนู ุฃุฑูุงู ููุทุ (ูุฌุจ ุฃู ูููู ุฑููุงู)
    - ุชุญูู 2: ูู FDC ID โ "ูุฑูุจ" ุฃู "ูุฎููุท" ุฃู "composite"ุ
    - ุชุญูู 3: ูู ูุตู USDA ูุง ูุญุชูู ุนูู "mixed" ุฃู "with"ุ
    - ุฅุฐุง ูุดู ุฃู ุชุญูู: ุนุฏ ุฅูู ุงูุฎุทูุฉ 2.1 ููุฐุง ุงููููู
ุงููุฑุญูุฉ 3: ุงูุญุณุงุจ ุงูุบุฐุงุฆู
ููู ูููู (ูุน FDC ID ู final_qty):
ุงูุฎุทูุฉ 3.1: ุงุณุชุฑุฌุงุน ุจูุงูุงุช USDA
  - ุงุณุชุฎุฏู FDC ID ูุณุญุจ ุจูุงูุงุช ุงูุนูุงุตุฑ ุงูุบุฐุงุฆูุฉ ุงูู 34 ููู 100 ุฌู/ูู
ุงูุฎุทูุฉ 3.2: ุญุณุงุจ ุงูููู ุงููุนููุฉ
  - ููู ุนูุตุฑ ุบุฐุงุฆู i ูู ุงูู 34:
    nutrient_value_i = (final_qty / 100) ร usda_value_i
ุงูุฎุทูุฉ 3.3: ุงูุชุฎุฒูู
  - ุฎุฒู ุงูููู ุงููุญุณูุจุฉ ูู ุงูุตู ุงูููุงุจู ูู ุงูุฌุฏูู
  - ุชุฃูุฏ ูู ูุฌูุฏ 34 ูููุฉ ุฑูููุฉ (ุญุชู ูู 0.0)
ุงููุฑุญูุฉ 4: ุงูุชุฌููุน ูุงูุชุญูู
ุงูุฎุทูุฉ 4.1: ุฅูุดุงุก ุงูุฌุฏูู ุงููุงูู
๐๏ธ ูููู ุงูุฌุฏูู ุงูููุงุฆู (43 ุนููุฏุงู)
ุงูุฃุนูุฏุฉ ุงููุตููุฉ (1-9):
A: ุงูุตูู ุงูุบุฐุงุฆู
B: ุงููููุฉ/ุงูุนุฏุฏ
C: ุงููููู ุงูุฃุณุงุณู
D: ุงููููุฉ
E: ูุญุฏุฉ
F: ุทุฑููุฉ ุงูุชุญููู
G: ูุตุฏุฑ ุงููุตูุฉ
H: USDA FDC ID (ุฑูู ููุท)
I: USDA Description (ูุตู ูุงูู)

ุงูุฃุนูุฏุฉ ุงูุบุฐุงุฆูุฉ (10-43): ุงูุนูุงุตุฑ ุงูู 34 ุจุงูุชุฑุชูุจ:
J: calories
K: protein
L: totalFat
M: saturatedFats
N: monounsaturatedFats
O: polyunsaturatedFats
P: cholesterol
Q: carbohydrates
R: fiber
S: sugars
T: sodium
U: potassium
V: calcium
W: iron
X: magnesium
Y: zinc
Z: copper
AA: phosphorus
AB: manganese
AC: seleniumMcg
AD: iodineMcg
AE: vitaminAMcg
AF: vitaminDMcg
AG: vitaminEMg
AH: vitaminKMcg
AI: vitaminCMg
AJ: vitaminB1Mg
AK: vitaminB2Mg
AL: vitaminB3Mg
AM: vitaminB6Mg
AN: folateMcg
AO: vitaminB12Mcg
AP: cholineMg
AQ: waterL
๐ ูุซุงู ุชุทุจููู: "ุฎุจุฒ ุจูุฏู"
csv
"ุฎุจุฒ ุจูุฏู";"1 ุฑุบูู (~90 ุฌู)";"ุฎุจุฒ ุนุฑุจู/ุจูุฏู";90;"g";"USDA_DIRECT_MATCH";"-";172184;"Bread, pita, white";247.5;8.1;0.63;0.135;0.09;0.27;0;49.5;2.7;0.9;482.4;135;27;1.8;45;0.9;0.135;90;0.45;18.9;1.8;0;0;0.18;0.9;0;0.09;0.09;0.9;0.09;18;0;13.5;0.063
โ๏ธ ุชูุณูู ุงูููู
ุงููุญุฏุฏ: ูุงุตูุฉ ููููุทุฉ ;
ูุญุฏุฏ ุงููุต: ุนูุงูุชู ุงูุชุจุงุณ ""
ุงูุชุฑููุฒ: UTF-8
ุงููุตุฏุฑ: Excel โ Data โ From Text/CSV โ Delimiter: ;
โ ุดุฑูุท ูุฌุงุญ ุงููุธุงู
ูู ุตู ูุญุชูู ุนูู 43 ุนููุฏุงู ุจุงูุถุจุท
ูู ูููู ูู 34 ูููุฉ ุบุฐุงุฆูุฉ (ุฑููุ ุญุชู ูู 0)
ุฃุณูุงุก ุงูุฃุนูุฏุฉ ุจุฏูู ูุณุงูุงุช
ุงููุตู ุงููุงูู ุฏุงุฎู " "
FDC ID ุฑููุงู ููุท
ุงูุฎุทูุฉ 4.2: ุงูุชุญูู ูู ุงูุชูุงุณู
- ุชุญูู 1: ูู ุตู ูุญุชูู ุนูู 43 ุนููุฏุงู ุจุงูุถุจุท
- ุชุญูู 2: ุงูุฃุนูุฏุฉ J-AQ ูููุง ุฃุฑูุงู (ูุง ูุตูุต)
- ุชุญูู 3: ูุง ุชูุฌุฏ ููู ููููุฏุฉ (ูุชู ุชุนุจุฆุฉ 0.0 ุฅุฐุง ูุงูุช ุบูุฑ ูุชููุฑุฉ)
- ุชุญูู 4: ุนุฏุฏ ุงูุตููุฏ ูุฌุจ ุฃู ูุณุงูู:
  (ุนุฏุฏ ุงูุฃุตูุงู ุงููุจุงุดุฑุฉ ูู USDA) + (ูุฌููุน ููููุงุช ุฌููุน ุงููุตูุงุช)
    ูุซุงู: ุฅุฐุง ูุงู ูุฏููุง 3 ุฃุตูุงู ูุฑูุจุฉ ุชุญุชูู ุนูู [2, 3, 2] ููููุงุช
  ู4 ุฃุตูุงู ูุจุงุดุฑุฉุ ูุฅู ุงูุนุฏุฏ ุงูุฅุฌูุงูู ููุตููุฏ ูุฌุจ ุฃู ูููู:
  4 + (2+3+2) = 11 ุตูุงู
  - ุชุญูู 5: ูุง ููุฌุฏ ุนููุฏ "ุงููููู ุงูุฃุณุงุณู" ูุญุชูู ุนูู ูููุฉ "ูุน" ุฃู "ุจู"
text
- ุชุญูู 6: ุชุณุฌูู ููุฌุฒ ูููุฑุงุฑุงุช ุงูุฑุฆูุณูุฉ
  * ููู ุตูู ุจู method = "RECIPE_DECOMPOSITION":
    - ุนุฏุฏ ุงูููููุงุช ุงูุฃุตููุฉ ูู ุงููุตูุฉ
    - ุนุฏุฏ ุงูููููุงุช ุจุนุฏ ุงูุชุตููุฉ
    - ุงูููููุงุช ุงููุณุชุจุนุฏุฉ ูุณุจุจ ุงูุงุณุชุจุนุงุฏ
  * ูุซุงู: "ูุดู ุจุงูุจุตู: 5 ููููุงุช โ 3 ููููุงุชุ ูุณุชุจุนุฏ: ููุญ (ูุงุนุฏุฉ 2)ุ ูุงุก (ูุงุนุฏุฉ 2)"
ุงูุฎุทูุฉ 4.3: ุญุณุงุจ ุงูุฅุฌูุงููุงุช
- ููู ุนูุตุฑ ุบุฐุงุฆู iุ ุงุฌูุน ุงูููู ูู ุฌููุน ุงูุตููู:
  total_nutrient_i = ฮฃ nutrient_value_i ูุฌููุน_ุงูููููุงุช
ุงููุฑุญูุฉ 5: ุงูุฅุฎุฑุงุฌ ุงูููุงุฆู
1. ุงูุฌุฏูู ุงููุงูู (CSV):
   - ูุญุฏุฏ: ูุงุตูุฉ ููููุทุฉ ;
   - ูุญุฏุฏ ูุตูุต: ุนูุงูุชู ุงูุชุจุงุณ ""
   - ุงูุชุฑููุฒ: UTF-8
2. ุฅุฌูุงููุงุช ุงูุนูุงุตุฑ ุงูู 34 (JSON):
   - ูุงุฆู ูุญุชูู ุนูู ุฅุฌูุงูู ูู ุนูุตุฑ
   - ูุน ุงูุชุญูู: "ุชู ุงูุชุญูู: ุฌููุน ุงูุฅุฌูุงููุงุช ูุทุงุจูุฉ ููุฌููุน ูุณุงููุงุช ุงูุฃุตูุงู"
ููุงุญุธุงุช ุงูุชูููุฐ ุงูุญุฑุฌุฉ:
ุนุฏู ุงูุงูุชุฑุงุถ: ูุง ุชูุชุฑุถ ุฃู ูุตูุฉ ุฃู ูููุฉ. ูู ุดูุก ูุฌุจ ุงุณุชุฎุฑุงุฌู ูู ุงููุตุฏุฑ.
ุงูุชูุซูู ุงููุงูู: ุณุฌู ูู ูุฑุงุฑ (ุณุจุจ ุงุฎุชูุงุฑ FDC IDุ ุณุจุจ ุงุณุชุจุนุงุฏ ูููู).
ุงูุซุจุงุช ุนุจุฑ ุงูุฌูุณุงุช: ููุณ ุงูุตูู โ ููุณ ุงูุชุญููู โ ููุณ ุงููุชุงุฆุฌ.
ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก: ุฅุฐุง ูุดู ุงูุจุญุซ ูู ุฌููุน ุงููุตุงุฏุฑุ ุฃุนุฏ ุฎุทุฃ ูุงุถุญุงู.

ุงูุทุนุงู ุงููุฏุฎู:
"ุฏููุฉ ุจุงููุฉุ ูุณูุนุฉ ุจุงููุญู ุงูููุฑููุ ููููุจุฉ ุจุงููุญู ุงูุถุงููุ ูุณูุณู ุจุงูุณูุฑุ ุทุจู ูุดุฑู ุจุงูุฏูุฉุ ูฃ/ูค ููุจ ูุดู ุจุงูุจุตูุ ุทุจู ุดูุดููุฉุ ูฃ/ูค ููุจ ูุชูุณุท ูููุฎูุฉุ ุฑุจุน ุฏุฌุงุฌุฉ ูุญูุฑุฉ (ุตุฏุฑ) ูุฒู ุงููุฑุฎุฉ ุตุงูู ูุจู ุงูุทูู ูกุูขูฅู ุฌุฑุงูุ ูุทุนุฉ ููุฑููุฉ ุจุงูุจุงุดููู ู ุงููุญู ุงูููุฑูู, 4 ูุญุฏุงุช ูุญุดู ุจุงุฐูุฌุงู ุงุจูุถ, ุณุงูุฏูุชุด ุทุฑุจ ุจุงูุทุญููู, 3 ูุทุน ุจูุชุฒุง ุจุงุจุง ุฌููุฒ ุจุงูุจุจุฑููู, ุตููุฉ ุจุทุงุทุณ ุญูุฑุงุก ูู ุงููุฑู.

ุงุจุฏุฃ ุงููุนุงูุฌุฉ ููุฑุงู ุจุงุณุชุฎุฏุงู ุงูุฎูุงุฑุฒููุฉ ุงูุดุงููุฉ ููุธุงู ุชุญููู ุงูุชุบุฐูุฉ.

=====================================================================

ุชุฐููุฑ ููุงุฆู:
- ุชุฌุงููู "ุงูุทุนุงู ุงููุฏุฎู" ุงููุฐููุฑ ูู ูุต ุงูุฎูุงุฑุฒููุฉ ุฃุนูุงู ุจุงุนุชุจุงุฑู ูุซุงูุงู ุชุฏุฑูุจูุงู ููุท.
- ุงุณุชุฎุฏู ููุท ุงููุต ุงูุชุงูู ููุฏุฎู ูุนูู ููุชุญููู:
"$dietInput"

ุจุนุฏ ุชูููุฐ ุฌููุน ุงููุฑุงุญูุ ุฃุฎุฑุฌ JSON ููุท ุจุงููููู ุงููุญุฏุฏ ุณุงุจููุง ููุง ุชุถู ุฃู ูุต ุขุฎุฑ.
''';
  }

  static Future<SingleNutrientModel?> analyzeSingleNutrient({
    required String dietInput,
    required String targetNutrient,
    required int targetValue,
  }) async {
    try {
      AppLogger.debug(
          'DeepSeek Single Nutrient: $apiKey $deepSeekBaseUrl | nutrient: $targetNutrient');

      final prompt = buildSingleNutrientPrompt(
        dietInput: dietInput,
        targetNutrient: targetNutrient,
        targetValue: targetValue,
      );

      final response = await http.post(
        Uri.parse(deepSeekBaseUrl),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $apiKey',
        },
        body: jsonEncode(
          {
            'model': "deepseek/deepseek-chat",
            'messages': [
              {
                'role': 'user',
                'content': prompt,
              }
            ],
            'max_tokens': 1000,
            'temperature': 0.2,
          },
        ),
      );

      if (response.statusCode == 200) {
        /// ๐ฅ ุชุตุญูุญ ุงูุชุฑููุฒ ููู response ูุงูู
        final decodedResponse = jsonDecode(utf8.decode(response.bodyBytes));
        final content = decodedResponse['choices'][0]['message']['content'];

        AppLogger.debug("DeepSeek Parsed Content:\n$content");

        /// ุงุณุชุฎุฑุงุฌ JSON ููุท ูู ุงููุต
        final match = RegExp(r'\{.*\}', dotAll: true).firstMatch(content);
        if (match != null) {
          final jsonRaw = match.group(0)!;

          /// โ ูุง ูุณุชุฎุฏู utf8.decode ููุง โ ูุจุงุดุฑุฉ JSON decode
          final parsed = jsonDecode(jsonRaw);

          return SingleNutrientModel.fromJson(parsed);
        }
        AppLogger.error("โJSON Not Found in response");
      } else {
        AppLogger.error("API Error ${response.statusCode} โ ${response.body}");
      }
    } catch (e) {
      AppLogger.error("โError analyzing single nutrient โ $e");
    }
    return null;
  }

  /// ูุจูู ุงูุจุฑููุจุช ูุชุญููู ุนูุตุฑ ุบุฐุงุฆู ูุงุญุฏ (Dynamic Nutrient)
  static String buildSingleNutrientPrompt({
    required String dietInput,
    required String targetNutrient,
    required int targetValue,
  }) {
    return '''
ุฃูุช ูุญูู ุบุฐุงุฆู ูุชุฎุตุต. ุณูุชู ุชุฒููุฏู ุจุนูุตุฑ ุบุฐุงุฆู ูุงุญุฏ ูุณุชูุฏู ููุชุญููู (ูุซู: ุจุฑูุชููุ ูุงููุฑูุ ููุชุงููู C...)
ูุจูุงุฆูุฉ ุฃุทุนูุฉ ููุดุฑูุจุงุช ุชู ุงุณุชููุงููุง ุฎูุงู ุงููููุ ุฅุถุงูุฉู ุฅูู "ูููุฉ ูุฏู" ูุฌุจ ุฃู ูุง ูุชุฌุงูุฒูุง ูุฌููุน ุงูุชุญููู.

ุงูุนูุตุฑ ุงููุทููุจ ุชุญูููู: "$targetNutrient"  
ุงููููุฉ ุงููุตูู ุงููุณููุญ ุจูุง ููุฐุง ุงูุนูุตุฑ: $targetValue  

----------

# ูููุชู ุงูุฃุณุงุณูุฉ

1) ุชุญููู ูู ุตูู ุบุฐุงุฆู ูุงุฑุฏ ูู ุงููุงุฆูุฉ ุจุฏูู ุงุณุชุซูุงุก.  
2) ุชูุฏูุฑ ุงูุฃูุฒุงู ูุงูุงุญุฌุงู ูุชุญููููุง ุฅูู ุฌุฑุงู/ูู ุญุณุจ ุงูููุงุนุฏ ุงูุขุชูุฉ:
   - ุจูุถุฉ = 50 ุฌู
   - ุฑุงุญุฉ ูุฏ ุจุฑูุชูู โ 100โ120 ุฌู
   - ูุจุถุฉ ูุฏ ูุดููุงุช/ูุงููุฉ โ 120โ150 ุฌู
   - ุทุจู ุนุงุฏู ููุชูุฆ โ 300โ350 ุฌู
   - ููุจ = 240 ูู
   - ููุนูุฉ ูุจูุฑุฉ = 15 ุฌู/ูู
   - ููุนูุฉ ุตุบูุฑุฉ = 5 ุฌู/ูู
3) ุงูุงุนุชูุงุฏ ุนูู USDA FoodData Central ููุตุฏุฑ ุฃุณุงุณู ูููู "$targetNutrient".  
4) ุนูุฏ ุงูุบููุถุ ุงุณุชุฎุฏู ุงููุฒู ุงูููุงุณู ุงูุฃูุซุฑ ุดููุนูุง ูู USDA.  
5) ุงูุทูู:
   - ุงูููู ูุถูู 12 ุฌู ุฒูุช ุงูุชุฑุงุถููุง ููู ุญุตุฉ ุฅุฐุง ูู ูุฐูุฑ ุงููุณุชุฎุฏู ูููุฉ ุงูุฒูุช.
   - ุงูุณูู ูุงูุดูู ูุง ูุถููุงู ุฏููููุง ุชุฐูุฑ.
6) **ููููุน ุงุฎุชุฑุงุน ุฃุทุนูุฉ ุบูุฑ ูุฐููุฑุฉ** โ ุงูุชุฒู ุจูุต ุงููุฏุฎูุงุช ููุท.
7) ุงููุทููุจ ุญุณุงุจ **"$targetNutrient" ููุท**.
8) **ููู ุฌุฏุงู โ ุงูุชูููุฏ ุจุงููููุฉ ุงููุตูู targetValue**:
   - ูุฌููุน "$targetNutrient" ูู ุฌููุน ุงูุฃุตูุงู **ูุฌุจ ุฃูุง ูุชุฌุงูุฒ $targetValue**.
   - ุฅุฐุง ูุงูุช ุงูููู ุงููุญุณูุจุฉ ุชุชุฌุงูุฒ ุงูุญุฏุ ูู ุชููุงุฆููุง ุจุนูู:
     - ูุฑุงุฌุนุฉ ุชูุฏูุฑ ุงููููุงุชุ
     - ุงุฎุชูุงุฑ ุฃูู ุงูุชูุฏูุฑุงุช ุงูููุทููุฉุ
     - ุถุจุท ุงูุญุตุต ุจุญูุซ ูุจูู ูุฌููุน "$targetNutrient" โค $targetValueุ
     - ุฏูู ุงุฎุชูุงู ุจูุงูุงุช ุบูุฑ ููุฌูุฏุฉ.
   - ุงููุฏู: **ูุชูุฌุฉ ููุงุฆูุฉ ูุชุณูุฉ ูุบูุฑ ูุชุถุงุฑุจุฉุ ูุง ุชุชุฎุทู ุงููููุฉ ุงููุญุฏุฏุฉ.**

9) ูุงุนุฏุฉ ุงูุงูุชุฒุงู ุงูุฅุฌุจุงุฑู ุจุงููุฏู (CRITICAL RULE):
   - ูุฌููุน ููู "$targetNutrient" ููู ุงูุฃุตูุงู **ูุฌุจ ุฃู ูุณุงูู ุชูุงููุง** ุงููููุฉ "$targetValue" ุฃู ูููู ุฃูู ูููุง ุจุดูู ุจุณูุท ุฌุฏูุง (<= 1%).
   - ุฅุฐุง ุฃุฏุช ุงููููุงุช ุงูุชูุฏูุฑูุฉ ุงูุนุงุฏูุฉ ุฅูู ุชุฌุงูุฒ "$targetValue"ุ ูุฌุจ ุนููู ุฅุนุงุฏุฉ ุชูุฏูุฑ ุงููููุงุช ุชููุงุฆููุง:
       * ุชูููู ุญุฌู ุงูุญุตุฉุ
       * ุงุณุชุฎุฏุงู ุงูุญุฏ ุงูุฃุฏูู ุงูููุทููุ
       * ุฃู ุฅุนุงุฏุฉ ุถุจุท ุงููุฒู ุงูุงูุชุฑุงุถู ููุตูู.
   - **ููููุน ููุนูุง ุจุงุชูุง** ุฃู ูููู ูุฌููุน ุงูููู ูู ุงูุญูู "total_nutrient_intake" ุฃุนูู ูู "$targetValue".
   - **ููููุน ูุฐูู** ุฃู ูุธูุฑ "total_nutrient_intake" ุถูู ุงูุญุฏ ุจูููุง ูุฌููุน ุงูููู ุฏุงุฎู "items" ูุชุฌุงูุฒู โ ููุงููุง ูุฌุจ ุฃู ูุชุทุงุจูุง ุฑูุงุถููุง.
   - ูู ุญุงูุฉ ูุฌูุฏ ุชุถุงุฑุจุ ุฃุนุฏ ุงูุญุณุงุจ ุญุชู ูุตุจุญ:
       total_nutrient_intake == sum(items[nutrient_intake])
   - ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ: **ูุง ูุชู ุฅููุงุก ุงูุญุณุงุจ ูุจู ุงูุชุฃูุฏ ุฃู ุฅุฌูุงูู ุงููุฏุฎูู ุงูููุงุฆู ูุทุงุจู ููุญุฏ ุงููุณุชูุฏู ุจุดูู ุฏููู.**

----------


# ูุงุฆูุฉ ุงูุฃุทุนูุฉ ูุงููุดุฑูุจุงุช:

"$dietInput"

----------

ุฃุฑุฌุน ุงููุชูุฌุฉ ุจุงูุตูุบุฉ ุงูุชุงููุฉุ ูุน ุฃุฑูุงู ูุนููุฉ ุจุฏู ุงูุฃุตูุงุฑ:

{
  "items": [
    {
      "name": "ุงุณู ุงูุตูู ุงูุบุฐุงุฆู",
      "quantity_grams": 0,
      "nutrient_per_100g": 0,
      "nutrient_intake": 0
    }
  ],
  "total_nutrient_intake": 0
}

- name: ุงุณู ุงูุตูู ููุง ูุณูุฑุชู ุฃูุช.
- quantity_grams: ุงููุฒู ุงููุนูู ุงูููุฏุฑ ุฃู ุงููุฐููุฑ (ุจุงูุฌุฑุงู ุฃู ูุง ูุนุงุฏููุง ูู ูู).
- nutrient_per_100g: ูููุฉ "$targetNutrient" ููู 100 ุฌู/ูู ุญุณุจ ุงููุฑุฌุน ุงูุบุฐุงุฆู.
- nutrient_intake: ุงููููุฉ ุงููุนููุฉ ุงููุณุชูุฏุฉ ูู ุงููููุฉ ุงููุชูุงููุฉ.
- total_nutrient_intake: ูุฌููุน ูู "nutrient_intake" ููู ุงูุฃุตูุงู.

ุฃุฑุฌุน JSON ููุท ุจุฏูู ุฃู ูุต ุฃู ุดุฑุญ ุฅุถุงูู ุฎุงุฑุฌ ุงูุจููุฉ ุงูุณุงุจูุฉ.
''';
  }
}

// 9) **ููู ุฌุฏุงู โ ุงูุงุชุณุงู ุจูู ูู ุตูู ูุงููุชูุฌุฉ ุงูููุงุฆูุฉ:**
//    - ูุฌุจ ุฃู ูููู ูุฌููุน "nutrient_intake" ูุฌููุน ุงูุฃุตูุงู ูุทุงุจููุง ูููุฌุงู ุงูููุทูู ุจุญูุซ ูุง ูุชุนุฏู "target_limit".
//    - ุฅุฐุง ูุงู ุตูู ูุงุญุฏ ููุชูู ูููุฉ "$targetNutrient" ุนุงููุฉ ุชุฑูุน ุงููุฌููุน ููู $targetValueุ ูุฌุจ ุชุนุฏูู ุชูุฏูุฑ ุงููููุฉ ุชููุงุฆููุง ูุชุตุจุญ ุงููููุฉ ููุทููุฉ ูุชุจูู ุงููุชูุฌุฉ ุงูููุงุฆูุฉ ุถูู ุงูุญุฏ.
//    - **ููููุน ุชูุงููุง ุฃู ูุธูุฑ ุฃู ุตูู ุจูููุฉ nutrient_intake ุชุคุฏู ุฅูู ุฅุฌูุงูู ุฃุนูู ูู $targetValue ุจูููุง ูุธูุฑ total_nutrient_intake ุฃูู ุฃู ูุณุงูู ุงูุญุฏ.**
//    - ุฌููุน ุงูููู ูุฌุจ ุฃู ุชููู ูุชูุงุณูุฉุ ููุทููุฉุ ููุง ุชุนุชูุฏ ุนูู ุชุฎููุถ ุงููุฌููุน ุงูููุงุฆู ููุท ุฏูู ุชุนุฏูู ุงูููู ุงููุฑุฏูุฉ.
